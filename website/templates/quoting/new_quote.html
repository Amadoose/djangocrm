{% extends 'base.html' %}
{% load static %}
{% block content %}
{% block extra_head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/new_quote.css' %}">
{% endblock %}

<div style="min-height: 85vh; display: flex; align-items: center; justify-content: center; color: #8e8e93;">
    <p>Cargando formulario de nueva cotizaciÃ³n...</p>
</div>

<!-- Modal Overlay -->
<div class="modal-overlay" id="folioModalOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;"></div>

<!-- Modal Container -->
<div class="modal-container" id="folioModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1001; display: flex; align-items: center; justify-content: center;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="bi bi-file-earmark-plus"></i>
                Nuevo Folio
            </h2>
            <button class="modal-close" id="closeFolioModal">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <form class="modal-form" id="folioForm">
            <!-- Folio ID Field -->
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-hash"></i>
                    Folio
                </label>
                <div class="folio-id-container">
                    <span class="folio-id">#NUEVO</span>
                    <small class="form-help">Se asignarÃ¡ automÃ¡ticamente al crear</small>
                </div>
            </div>

            <!-- Cliente Field -->
            <div class="form-group">
                <label class="form-label required">
                    <i class="bi bi-person"></i>
                    Cliente
                </label>
                <div class="search-container">
                    <select class="form-control search-select" id="clienteSelect" name="cliente" required>
                        <option value="">Buscar cliente...</option>
                        <option value="1">Juan PÃ©rez GarcÃ­a</option>
                        <option value="2">MarÃ­a LÃ³pez HernÃ¡ndez</option>
                        <option value="3">Carlos RodrÃ­guez MartÃ­n</option>
                    </select>
                    <i class="bi bi-search search-icon"></i>
                </div>
            </div>

            <!-- CelebraciÃ³n Field -->
            <div class="form-group">
                <label class="form-label required">
                    <i class="bi bi-calendar-heart"></i>
                    CelebraciÃ³n
                </label>
                <select class="form-control" name="tipo_viaje" required>
                    <option value="">Seleccionar celebraciÃ³n...</option>
                    <option value="honeymoon">ğŸ’• Luna de Miel</option>
                    <option value="anniversary">ğŸ‰ Aniversario</option>
                    <option value="birthday">ğŸ‚ CumpleaÃ±os</option>
                    <option value="vacation">ğŸ–ï¸ Vacaciones</option>
                    <option value="business">ğŸ’¼ Viaje de Negocios</option>
                    <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Viaje Familiar</option>
                    <option value="graduation">ğŸ“ GraduaciÃ³n</option>
                    <option value="wedding">ğŸ’’ Boda</option>
                    <option value="other">âœ¨ Otro</option>
                </select>
            </div>

            <!-- Agente Field -->
            <div class="form-group">
                <label class="form-label required">
                    <i class="bi bi-person-badge"></i>
                    Agente
                </label>
                <div class="search-container">
                    <select class="form-control search-select" id="agenteSelect" name="agente" required>
                        <option value="">Buscar agente...</option>
                        <option value="1">Ana GarcÃ­a (ana.garcia)</option>
                        <option value="2">Luis MartÃ­n (luis.martin)</option>
                        <option value="3">Carmen LÃ³pez (carmen.lopez)</option>
                    </select>
                    <i class="bi bi-search search-icon"></i>
                </div>
            </div>

            <!-- Created At Field -->
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-calendar3"></i>
                    Fecha de CreaciÃ³n
                </label>
                <div class="created-at-container">
                    <span class="created-at" id="createdAtDisplay"></span>
                    <small class="form-help">Se establecerÃ¡ al momento de crear</small>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelFolio">
                    <i class="bi bi-x-circle"></i>
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i>
                    Crear Folio
                </button>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'js/new_quote.js' %}"></script>
<script>
    console.log('Script loading...');

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing modal...');
        
        const modal = document.getElementById('folioModal');
        const modalOverlay = document.getElementById('folioModalOverlay');
        const closeBtn = document.getElementById('closeFolioModal');
        const cancelBtn = document.getElementById('cancelFolio');
        const createdAtDisplay = document.getElementById('createdAtDisplay');
        
        console.log('Elements found:', {
            modal: !!modal,
            modalOverlay: !!modalOverlay,
            closeBtn: !!closeBtn,
            cancelBtn: !!cancelBtn,
            createdAtDisplay: !!createdAtDisplay
        });
        
        // Function to show current time
        function updateCurrentTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            if (createdAtDisplay) {
                createdAtDisplay.textContent = now.toLocaleDateString('es-ES', options);
            }
        }
        
        // Function to open modal
        function openModal() {
            console.log('Opening modal...');
            
            if (modalOverlay && modal) {
                modalOverlay.classList.add('active');
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                updateCurrentTime();
                
                // Update time every second while modal is open
                window.timeInterval = setInterval(updateCurrentTime, 1000);
                
                console.log('Modal opened successfully');
            } else {
                console.error('Modal elements not found!');
            }
        }
        
        // Function to close modal
        function closeModal() {
            console.log('Closing modal...');
            
            if (modalOverlay && modal) {
                modalOverlay.classList.remove('active');
                modal.classList.remove('active');
                document.body.style.overflow = '';
                
                // Clear time interval
                if (window.timeInterval) {
                    clearInterval(window.timeInterval);
                }
                
                // Reset form
                const form = document.getElementById('folioForm');
                if (form) {
                    form.reset();
                }
                
                console.log('Modal closed successfully');
            }
        }
        
        if (closeBtn) {
            closeBtn.addEventListener('click', function(e) {
                console.log('Close button clicked');
                e.preventDefault();
                closeModal();
            });
        }
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
                console.log('Cancel button clicked');
                e.preventDefault();
                closeModal();
            });
        }
        
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                console.log('Overlay clicked');
                closeModal();
            });
        }
        
        // Prevent modal from closing when clicking inside the modal content
        if (modal) {
            modal.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
                console.log('Escape key pressed');
                closeModal();
            }
        });
        
        // Auto-open modal when page loads with a small delay
        console.log('Auto-opening modal...');
        setTimeout(() => {
            openModal();
        }, 100);
        
        console.log('Modal initialization complete');
    });
</script>

{% endblock %}